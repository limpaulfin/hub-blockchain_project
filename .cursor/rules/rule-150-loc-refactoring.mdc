---
description: 
globs: 
alwaysApply: false
---
*Mod by Fong on 2025-06-15--15-32-PM*

# Rule: Universal 150 LOC Refactoring Protocol

**Debug UUID:** `1264476f-6224-483c-98a0-0020170d54fd`

## Core Requirement (KR)
**Má»—i file code PHáº¢I <= 150 LOC** (Ã¡p dá»¥ng cho táº¥t cáº£ ngÃ´n ngá»¯)

## 5 TiÃªu ChÃ­ Lá»±a Chá»n Universal

### 1. **KISS Principle** - ÄÆ¡n giáº£n nháº¥t
- Function/method cÃ³ logic Ä‘Æ¡n giáº£n, Ã­t phá»©c táº¡p
- KhÃ´ng cÃ³ nested conditions phá»©c táº¡p
- Dá»… hiá»ƒu, dá»… Ä‘á»c (báº¥t ká»ƒ ngÃ´n ngá»¯)

### 2. **Low Risk** - Ãt áº£nh hÆ°á»Ÿng core functionality
- KhÃ´ng áº£nh hÆ°á»Ÿng business logic chÃ­nh
- Utility functions, helper functions
- UI components Ä‘Æ¡n giáº£n (CSS/HTML)
- Configuration/constants

### 3. **Easy Migration** - TÆ°Æ¡ng tá»± patterns thÃ nh cÃ´ng
- Pattern Ä‘Ã£ test thÃ nh cÃ´ng
- KhÃ´ng phá»¥ thuá»™c nhiá»u dependencies
- Pure functions hoáº·c simple utilities
- Standalone components

### 4. **Quick Win** - Má»¥c tiÃªu <150 LOC
- File má»›i: <150 LOC
- File gá»‘c: giáº£m Ã­t nháº¥t 8-10 LOC
- Táº¡o module/component cÃ³ Ã½ nghÄ©a
- KhÃ´ng táº¡p nham, khÃ´ng fragment

### 5. **Safe Testing** - Dá»… test vÃ  verify
- Function/component cÃ³ thá»ƒ test Ä‘á»™c láº­p
- Ãt side effects
- CÃ³ error handling (náº¿u Ã¡p dá»¥ng)
- Dá»… verify functionality

## Function/Component Selection Priority
- PhÃ¢n tÃ­ch file theo 5 tiÃªu chÃ­ universal
- Chá»n function/component Ä‘Æ¡n giáº£n nháº¥t, rá»§i ro tháº¥p nháº¥t
- Æ¯u tiÃªn theo ngÃ´n ngá»¯:
  - **Python**: utility functions, helper functions
  - **PHP**: helper functions, utility classes
  - **JavaScript**: utility functions, pure functions
  - **CSS**: utility classes, mixins, variables
  - **HTML**: reusable components, partials

## Debug Tracking Requirements (Universal)

**Má»—i debug point PHáº¢I cÃ³ UUID** (sá»­ dá»¥ng `uuidgen`)

### Debug Points:
1. **Analysis Start**: Log UUID + file analysis + language
2. **Component Selection**: Log UUID + selection criteria + language-specific notes
3. **Implementation**: Log UUID + changes made + language-specific considerations
4. **Testing**: Log UUID + test results + language-specific verification
5. **Completion**: Log UUID + final metrics + language

### Debug Format:
```
DEBUG [UUID]: [LANG] [Stage] - [Description]
Example: DEBUG 1264476f-6224-483c-98a0-0020170d54fd: PHP ANALYSIS - UserHelper.php 180 LOC, target: validateEmail()
Example: DEBUG 1264476f-6224-483c-98a0-0020170d54fd: JS IMPLEMENTATION - utils.js extracted formatCurrency()
```

## Success Patterns (Multi-Language)

### âœ… Successful Extractions:
1. **Python**: `startup_utils.py`, `directory_utils.py`
2. **PHP**: Helper classes, Utility functions
3. **JavaScript**: Pure functions, Utility modules
4. **CSS**: Utility classes, Mixins, Variables
5. **HTML**: Reusable components, Partials

### ðŸ“‹ Target Candidates (by language):

#### Python
1. Utility functions, Helper functions
2. Configuration helpers, Constants
3. Error handling, Validation functions

#### PHP  
1. Helper classes, Utility functions
2. Validation functions, Formatters
3. Database helpers, API utilities

#### JavaScript/TypeScript
1. Pure functions, Utility modules
2. Helper functions, Formatters
3. Configuration objects, Constants

#### CSS/SCSS
1. Utility classes, Helper mixins
2. Variable definitions, Color palettes
3. Responsive mixins, Animation helpers

#### HTML/Vue/React
1. Reusable components, UI elements
2. Template partials, Layout components
3. Form components, Display components

## Metrics Tracking (Universal)

### Before/After:
- **Language**: [Python/PHP/JS/CSS/HTML]
- **Original LOC**: [number]
- **New Module LOC**: [number] 
- **Reduced LOC**: [number]
- **Target Achievement**: [Yes/No]

### Success Criteria (Universal):
- âœ… Original file LOC reduced
- âœ… New module < 150 LOC
- âœ… All tests pass (language-specific)
- âœ… No functionality broken
- âœ… Clean git history
- âœ… Proper imports/includes updated

---

**NguyÃªn táº¯c Universal:** Measure twice, cut once. Always backup. Test thoroughly. Language-agnostic approach.

---

## Universal Workflow (5 Steps)

### 1. Analysis & Init
```bash
uuidgen  # Táº¡o UUID debug tracking
wc -l path/to/target_file.*  # Kiá»ƒm tra LOC
```

### 2. Selection - Chá»n function/component theo 5 tiÃªu chÃ­
### 3. Implementation
```bash
git checkout -b feature/extract-[component-name]
cp target_file.* target_file.*.$(date '+%Y%m%d-%H-%M-%S').bak
# Extract + Update imports + Test
```

### 4. Testing & Verification
```bash
wc -l target_file.* new_module.*  # Universal LOC check
# Language-specific testing
```

### 5. Git Workflow
```bash
git add new_module.* target_file.*
git commit -m "refactor([lang]): Extract [component] to [new_module]"
git checkout main && git merge feature/extract-[component-name]
```

## Language-Specific Commands

### Python (.py)
```bash
python3 -c "from src.module import function; print('Import test: OK')"
```

### PHP (.php)
```bash
php -l src/target_file.php  # Syntax check
php -r "require 'src/new_module.php'; echo 'Import test: OK';"
```

### JavaScript (.js, .ts)
```bash
node -c src/target_file.js  # Syntax check
node -e "const func = require('./src/new_module.js'); console.log('Import test: OK');"
```

### CSS (.css, .scss)
```bash
sass --check styles/new_module.scss
```

## File Headers (Language-Specific)

### Python:
```python
# src/module_name.py
# *Mod by Fong on YYYY-MM-DD--HH-MM-PM*
"""Module description and purpose."""
```

### PHP:
```php
<?php
// src/ClassName.php  
// *Mod by Fong on YYYY-MM-DD--HH-MM-PM*
/**
 * Class description and purpose
 */
```

### JavaScript:
```javascript
// src/moduleName.js
// *Mod by Fong on YYYY-MM-DD--HH-MM-PM*
/**
 * Module description and purpose
 */
```

### CSS:
```css
/* styles/module-name.css */
/* *Mod by Fong on YYYY-MM-DD--HH-MM-PM* */
```

## Import Patterns

- **Python:** `from src.new_module import new_function`
- **PHP:** `require_once 'src/NewModule.php'; use App\Utils\NewModule;`
- **JavaScript:** `const { newFunction } = require('./src/newModule');`
- **CSS:** `@import 'styles/new-module.css';`

## Emergency Rollback
```bash
# Restore from backup
cp target_file.*.YYYYMMDD-HH-MM-SS.bak target_file.*
# Or git reset
git reset --hard HEAD~1
```